#include <catch2/catch_test_macros.hpp>
#include <iostream>

#include "JkBmsFrames.h"
#include "CppWrappers.h"

constexpr uint8_t SAMPLE_DEVICE_INFO_FRAME[] = {
0x55, 0xaa, 0xeb, 0x90, 
0x03, 
0x4b, 
0x4a, 0x4b, 0x5f, 0x42, 0x44, 0x36, 0x41, 0x32, 0x30, 0x53, 0x31, 0x30, 0x50, 0x00, 0x00, 0x00, 
0x31, 0x31, 0x2e, 0x58, 0x57, 0x00, 0x00, 0x00, 
0x31, 0x31, 0x2e, 0x32, 0x38, 0x31, 0x00, 0x00, 
0xa8, 0x6b, 0x09, 0x01, // uptimeSeconds
0x35, 0x00, 0x00, 0x00, // powerOnCounter
0x4a, 0x4b,
0x5f, 0x42, 0x44, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x30, 0x50, 0x00, 0x00, 0x00, 0x31, 0x31,
0x31, 0x31, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x32, 0x34,
0x30, 0x36, 0x30, 0x38, 0x00, 0x00, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x31,
0x00, 0x30, 0x30, 0x30, 0x30, 0x00, 0x49, 0x6e, 0x70, 0x75, 0x74, 0x20, 0x55, 0x73, 0x65, 0x72,
0x64, 0x61, 0x74, 0x61, 0x00, 0x00, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x66,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x49, 0x6e, 0x70, 0x75, 0x74, 0x20, 0x55, 0x73, 0x65, 0x72,
0x64, 0x61, 0x74, 0x61, 0x00, 0x00,
0xfc, 0xf9, 0xff, 0xff, 0x1f, 0x2d, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x90, 0x0f, 0x00, 0x00,
0x00, 0x00, 0xc0, 0xd8, 0x03, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x6c
};
    

TEST_CASE("checkFrameStart", "[JkBmsFrames]") {
    uint8_t correctBuffer[] = {0x55, 0xaa, 0xeb, 0x90, 0x00};
    JkBmsCpp::JkBmsDataBuffer buffer1(correctBuffer, 5);    
    REQUIRE(JkBmsCpp::checkFrameStart(buffer1) == true);

    uint8_t incorrectBuffer[] = {0x22, 0xaa, 0xeb, 0x90, 0x00};
    JkBmsCpp::JkBmsDataBuffer buffer2(incorrectBuffer, 5);
    REQUIRE(JkBmsCpp::checkFrameStart(buffer2) == false);

    JkBmsCpp::JkBmsDataBuffer buffer3((uint8_t*)SAMPLE_DEVICE_INFO_FRAME, 
        sizeof(SAMPLE_DEVICE_INFO_FRAME));    
    REQUIRE(JkBmsCpp::checkFrameStart(buffer3) == true);
}

TEST_CASE("checkFrameChecksum", "[JkBmsFrames]") {
    uint8_t correctBuffer[] = {0x55, 0xaa, 0xeb, 0x90, 0x01, 0x7b};
    JkBmsCpp::JkBmsDataBuffer buffer1(correctBuffer, 6);    
    REQUIRE(JkBmsCpp::checkFrameChecksum(buffer1) == true);

    uint8_t incorrectBuffer[] = {0x55, 0xaa, 0xeb, 0x90, 0x01, 0x2f};
    JkBmsCpp::JkBmsDataBuffer buffer2(incorrectBuffer, 6);    
    REQUIRE(JkBmsCpp::checkFrameChecksum(buffer2) == false);

    JkBmsCpp::JkBmsDataBuffer buffer3((uint8_t*)SAMPLE_DEVICE_INFO_FRAME, 
        sizeof(SAMPLE_DEVICE_INFO_FRAME));    
    REQUIRE(JkBmsCpp::checkFrameChecksum(buffer3) == true);
}

TEST_CASE("checkParseDeviceInfo", "[JkBmsFrames]") {
    JkBmsCpp::JkBmsDataBuffer buffer((uint8_t*)SAMPLE_DEVICE_INFO_FRAME, 
        sizeof(SAMPLE_DEVICE_INFO_FRAME));
    auto deviceInfo = JkBmsCpp::parseDeviceInfo(buffer);
    REQUIRE(deviceInfo.hasValue() == true);
    auto info = deviceInfo.value();
    REQUIRE(info.vendorId == "JK_BD6A20S10P");
    REQUIRE(info.hwVersion == "11.XW");
    REQUIRE(info.swVersion == "11.281");
    REQUIRE(info.uptimeSeconds == 0x1096ba8);
    REQUIRE(info.powerOnCounter == 53);
    REQUIRE(info.deviceName == "JK_BD1234560P");
    REQUIRE(info.devicePasscode == "1111");
    REQUIRE(info.manufacturedate == "240608");
    REQUIRE(info.serialNumber == "1234567891");
}